<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<dom-module id="paciente-search">
  <style>
    .list-item div {float: left;}
    .list-item-name {width: 200px}
  </style>
  <template>
    <iron-ajax id="service"
      auto
      handle-as="json"
      headers='{"Accept": "application/json"}'
      on-response="onPacientesResponse"
      debounce-duration="400"></iron-ajax>

      <paper-input id="q-paciente" name="name" label="nome do paciente" value="{{paciente}}" on-keyup="onKeyPressed"></paper-input>

      <template is="dom-if" if="{{showList}}">
        <p>Selecione o paciente que vocÃª deseja fazer o check-in</p>
        <ul>
          <template is="dom-repeat" items="{{pacientes}}">
            <paper-item role="menuitem" class="list-item">
              <paper-item-body one-line>
                <a data-route="checkin-paciente" on-click="onItemSelected">
                  <div class='list-item-name'>{{item.fields.nome}}</div>
                  <div class='list-item-icon' secondary>
                    <template is="dom-if" if="{{item.fields.data_nascimento}}">
                       nascido em <span>{{item.fields.data_nascimento}}<span>
                    </template>
                  </div>
                </a>
              </paper-item-body>
            </paper-item>
          </template>
        </ul>
      </template>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'paciente-search',

        properties: {
          pacientes: {
            type: Array,
            notify: true
          },
          paciente: {
            type: String,
            notify: true
          },
          showList: {
            type: Boolean,
            value: false,
            notify: true
          }
        },

        onKeyPressed: function(key)
        {
          this.$.service.url = 'http://localhost:8000/paciente/json/search/' + encodeURIComponent(this.paciente);
        },

        onPacientesResponse: function(response)
        {
          if (response.detail.response === null) {
            this.showList = false;
            return;
          }
          this.pacientes = response.detail.response.result;
          this.showList = this.pacientes.length > 0;
        },

        onItemSelected: function(a)
        {
          app.route = 'paciente-checkin';
          app.params = a.model.item;
        }
      });
    })();
  </script>

</dom-module>
